<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GeoMaster Web Controller</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; font-size: 14px; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã) */
        .top-panel {
            position: absolute; top: 10px; left: 2%; width: 96%;
            z-index: 1000; background: rgba(255,255,255,0.95);
            padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            box-sizing: border-box;
        }
        .coord-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .coord-val { font-family: monospace; font-weight: bold; }
        .badge { background: #007bff; color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; }

        /* –ü–∞–Ω–µ–ª—å –í—ã–Ω–æ—Å–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ—á–∫–∏) */
        .stakeout-panel {
            display: none; position: absolute; top: 110px; left: 2%; width: 96%;
            z-index: 1000; background: rgba(255,240,240,0.98); border: 2px solid #dc3545;
            padding: 10px; border-radius: 8px; box-sizing: border-box; text-align: center;
        }
        .stakeout-big { font-size: 24px; font-weight: bold; color: #dc3545; display: block; margin: 5px 0; }
        .stakeout-deltas { display: flex; justify-content: space-around; font-size: 12px; color: #555; }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            z-index: 1000; background: white; padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
            max-height: 40vh; overflow-y: auto;
        }
        .btn-row { display: flex; gap: 10px; justify-content: space-between; }
        button {
            flex: 1; padding: 10px; border: none; border-radius: 5px;
            background: #007bff; color: white; font-weight: bold; cursor: pointer;
        }
        button.record { background: #28a745; }
        button.stop { background: #6c757d; }
        button.delete { background: #dc3545; font-size: 12px; padding: 4px 8px; width: auto; flex: none; }
        
        /* –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ */
        #points-list { max-height: 150px; overflow-y: auto; margin-top: 5px; border-top: 1px solid #eee; }
        .point-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #eee;
        }
        .point-info { font-size: 12px; cursor: pointer; flex-grow: 1; }
        .point-info:hover { color: #007bff; }
        
        /* –ú–æ–¥–∞–ª–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ */
        #import-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 80%; }
        textarea { width: 100%; height: 100px; margin: 10px 0; font-family: monospace; font-size: 11px; }

    </style>
</head>
<body>

    <!-- –í–ï–†–•: –¢–µ–∫—É—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã -->
    <div class="top-panel">
        <div class="coord-row">
            <span>WGS84 (Lat/Lon)</span>
            <span class="coord-val" id="wgs-val">Waiting...</span>
        </div>
        <div class="coord-row">
            <span>–í—ã—Å–æ—Ç–∞ (H)</span>
            <span class="coord-val" id="alt-val">--</span>
        </div>
        <div class="coord-row">
            <span>–°–ö-42 <span class="badge" id="zone-badge">Z?</span></span>
            <span class="coord-val" id="sk42-val">--</span>
        </div>
        <div class="coord-row" id="local-row" style="display:none; color: #0056b3;">
            <span>–ú–°–ö <span class="badge" id="msk-badge">--</span></span>
            <span class="coord-val" id="msk-val">--</span>
        </div>
    </div>

    <!-- –í–´–ù–û–°: –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ —Ç–æ—á–∫–µ -->
    <div class="stakeout-panel" id="stakeout-panel">
        <div style="font-weight:bold; font-size:12px;">–í–´–ù–û–°: <span id="target-name">--</span></div>
        <span class="stakeout-big" id="dist-to-target">0.00 –º</span>
        <div class="stakeout-deltas">
            <span id="delta-north">dX: 0.0</span> | 
            <span id="delta-east">dY: 0.0</span> |
            <span id="target-azimuth">Az: 0¬∞</span>
        </div>
        <button class="stop" onclick="stopStakeout()" style="margin-top:5px; padding: 5px;">–°—Ç–æ–ø</button>
    </div>

    <div id="map"></div>

    <!-- –ù–ò–ó: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ -->
    <div class="bottom-panel">
        <div class="btn-row">
            <button class="record" onclick="recordPoint()">‚ûï –°–Ω—è—Ç—å —Ç–æ—á–∫—É</button>
            <button onclick="togglePoly()" id="poly-btn">üï∏Ô∏è –ì—Ä–∞–Ω–∏—Ü—ã: OFF</button>
        </div>
        <div class="btn-row">
            <button onclick="showImport()" style="background:#17a2b8;">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button onclick="exportPoints()" style="background:#6c757d;">üì§ –≠–∫—Å–ø–æ—Ä—Ç (TXT)</button>
        </div>
        
        <div id="points-list">
            <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ—á–∫–∏ -->
            <div style="text-align:center; color:#999; padding:10px;">–°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –ø—É—Å—Ç</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ -->
    <div id="import-modal">
        <div class="modal-content">
            <h3>–ò–º–ø–æ—Ä—Ç —Ç–æ—á–µ–∫ (WGS84)</h3>
            <p style="font-size:11px;">–§–æ—Ä–º–∞—Ç: –ò–º—è, –®–∏—Ä–æ—Ç–∞, –î–æ–ª–≥–æ—Ç–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</p>
            <textarea id="import-area" placeholder="P1, 59.934, 30.335&#10;P2, 59.935, 30.336"></textarea>
            <div class="btn-row">
                <button onclick="processImport()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button onclick="document.getElementById('import-modal').style.display='none'" class="stop">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // --- 1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        var map, userMarker, userAccuracyCircle;
        var currentPos = { lat: null, lng: null, alt: null, sk42: null };
        var points = []; // –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫: {id, name, lat, lng, sk42_x, sk42_y, h}
        var targetPoint = null; // –¢–æ—á–∫–∞ –¥–ª—è –≤—ã–Ω–æ—Å–∞
        var guideLine = null; // –õ–∏–Ω–∏—è –≤—ã–Ω–æ—Å–∞
        var boundaryPoly = null; // –ü–æ–ª–∏–≥–æ–Ω –≥—Ä–∞–Ω–∏—Ü
        var showBoundaries = false;

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –°–ö
        var towgs84_sk42 = "+towgs84=23.92,-141.27,-80.9,-0,0.35,0.82,-0.12"; 
        var ellps_krass = "+ellps=krass " + towgs84_sk42 + " +units=m +no_defs";
        var wgs84 = "+proj=longlat +datum=WGS84 +no_defs";

        // --- 2. –ì–ï–û–î–ï–ó–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ---
        function getGKZone(lon) { return Math.floor(lon / 6) + 1; }

        function convertToGrid(lat, lon) {
            var zone = getGKZone(lon);
            var cm = zone * 6 - 3;
            var sk42_proj = `+proj=tmerc +lat_0=0 +lon_0=${cm} +k=1 +x_0=${zone}500000 +y_0=0 ${ellps_krass}`;
            var sk42 = proj4(wgs84, sk42_proj, [lon, lat]); // [Easting(Y), Northing(X)]
            
            // –ê–≤—Ç–æ-–ú–°–ö (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –°–ü–±/–õ–û)
            var msk = null, msk_name = "";
            if (lat > 59 && lat < 61 && lon > 29 && lon < 32) {
                msk_name = "–ú–°–ö-64 z1";
                var msk64 = `+proj=tmerc +lat_0=0 +lon_0=29.95 +k=1 +x_0=95942.17 +y_0=-6552810.0 ${ellps_krass}`;
                msk = proj4(wgs84, msk64, [lon, lat]);
            }
            return { x: sk42[1], y: sk42[0], zone: zone, msk: msk ? {x: msk[1], y: msk[0]} : null, msk_name: msk_name };
        }

        // --- 3. –†–ê–ë–û–¢–ê –° –ö–ê–†–¢–û–ô –ò GPS ---
        function initMap() {
            map = L.map('map').setView([59.9343, 30.3351], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
            
            // –ó–∞–ø—É—Å–∫ GPS
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
                    enableHighAccuracy: true, maximumAge: 0, timeout: 5000
                });
            } else { alert("GPS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); }
        }

        function onLocationFound(e) {
            var lat = e.coords.latitude;
            var lng = e.coords.longitude;
            var acc = e.coords.accuracy;
            var alt = e.coords.altitude || 0; // GPS –≤—ã—Å–æ—Ç–∞

            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
            var grid = convertToGrid(lat, lng);
            currentPos = { lat: lat, lng: lng, alt: alt, sk42: grid };

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            document.getElementById('wgs-val').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${Math.round(acc)}–º)`;
            document.getElementById('sk42-val').innerText = `X:${grid.x.toFixed(2)} Y:${grid.y.toFixed(2)}`;
            document.getElementById('zone-badge').innerText = "Z" + grid.zone;
            document.getElementById('alt-val').innerText = `${Math.round(alt)} –º (GPS)`;

            if (grid.msk) {
                document.getElementById('local-row').style.display = 'flex';
                document.getElementById('msk-badge').innerText = grid.msk_name;
                document.getElementById('msk-val').innerText = `X:${grid.msk.x.toFixed(2)} Y:${grid.msk.y.toFixed(2)}`;
            }

            // –ú–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
            if (!userMarker) {
                userMarker = L.circleMarker([lat, lng], {color: 'red', radius: 6}).addTo(map);
                userAccuracyCircle = L.circle([lat, lng], {radius: acc, color: 'blue', opacity: 0.1}).addTo(map);
                map.setView([lat, lng], 17);
            } else {
                userMarker.setLatLng([lat, lng]);
                userAccuracyCircle.setLatLng([lat, lng]).setRadius(acc);
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –í–´–ù–û–°–ê
            if (targetPoint) updateStakeoutCalc();
        }

        function onLocationError(e) { console.warn("GPS Error: " + e.message); }

        // --- 4. –§–£–ù–ö–¶–ò–û–ù–ê–õ –¢–û–ß–ï–ö –ò –í–´–ù–û–°–ê ---

        // –ó–∞–ø–∏—Å—å —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–∏
        function recordPoint() {
            if (!currentPos.lat) return alert("–ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª GPS...");
            var name = prompt("–ò–º—è —Ç–æ—á–∫–∏ (P1, Wall, –∏ —Ç.–¥.):", "P" + (points.length + 1));
            if (!name) return;

            var p = {
                id: Date.now(),
                name: name,
                lat: currentPos.lat,
                lng: currentPos.lng,
                x: currentPos.sk42.x,
                y: currentPos.sk42.y,
                h: currentPos.alt
            };
            points.push(p);
            renderPointsList();
            if(showBoundaries) drawBoundaries();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
        function renderPointsList() {
            var container = document.getElementById('points-list');
            container.innerHTML = "";
            if (points.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            points.forEach(p => {
                var div = document.createElement('div');
                div.className = 'point-item';
                div.innerHTML = `
                    <div class="point-info" onclick="startStakeout(${p.id})">
                        <b>${p.name}</b> <br> X:${p.x.toFixed(2)} Y:${p.y.toFixed(2)}
                    </div>
                    <button class="delete" onclick="deletePoint(${p.id})">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function deletePoint(id) {
            points = points.filter(p => p.id !== id);
            if (targetPoint && targetPoint.id === id) stopStakeout();
            renderPointsList();
            if(showBoundaries) drawBoundaries();
        }

        // --- –õ–û–ì–ò–ö–ê –í–´–ù–û–°–ê (STAKEOUT) ---
        function startStakeout(id) {
            targetPoint = points.find(p => p.id === id);
            document.getElementById('stakeout-panel').style.display = 'block';
            document.getElementById('target-name').innerText = targetPoint.name;
            updateStakeoutCalc();
        }

        function stopStakeout() {
            targetPoint = null;
            document.getElementById('stakeout-panel').style.display = 'none';
            if (guideLine) map.removeLayer(guideLine);
        }

        function updateStakeoutCalc() {
            if (!currentPos.lat || !targetPoint) return;

            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (L.LatLng distanceTo –¥–∞–µ—Ç –º–µ—Ç—Ä—ã –Ω–∞ –≥–µ–æ–∏–¥–µ)
            var p1 = L.latLng(currentPos.lat, currentPos.lng);
            var p2 = L.latLng(targetPoint.lat, targetPoint.lng);
            var dist = p1.distanceTo(p2);

            // –ê–∑–∏–º—É—Ç –∏ –î–µ–ª—å—Ç—ã (–≤ –ø–ª–æ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –°–ö-42 –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏ —ç—Ç–æ –≤–∞–∂–Ω–µ–µ)
            // dX = –°–µ–≤–µ—Ä-–Æ–≥, dY = –í–æ—Å—Ç–æ–∫-–ó–∞–ø–∞–¥
            var dx = targetPoint.x - currentPos.sk42.x; // –ï—Å–ª–∏ +, –∑–Ω–∞—á–∏—Ç —Ü–µ–ª—å —Å–µ–≤–µ—Ä–Ω–µ–µ
            var dy = targetPoint.y - currentPos.sk42.y; // –ï—Å–ª–∏ +, –∑–Ω–∞—á–∏—Ç —Ü–µ–ª—å –≤–æ—Å—Ç–æ—á–Ω–µ–µ
            
            // –ê–∑–∏–º—É—Ç (–¥–∏—Ä–µ–∫—Ü–∏–æ–Ω–Ω—ã–π —É–≥–æ–ª)
            var azimuth = Math.atan2(dy, dx) * 180 / Math.PI;
            if (azimuth < 0) azimuth += 360;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('dist-to-target').innerText = dist.toFixed(2) + " –º";
            document.getElementById('delta-north').innerText = `dX: ${dx > 0 ? '‚¨Ü' : '‚¨á'}${Math.abs(dx).toFixed(2)}`;
            document.getElementById('delta-east').innerText = `dY: ${dy > 0 ? '‚û°' : '‚¨Ö'}${Math.abs(dy).toFixed(2)}`;
            document.getElementById('target-azimuth').innerText = `Az: ${Math.round(azimuth)}¬∞`;

            // –õ–∏–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
            if (guideLine) map.removeLayer(guideLine);
            guideLine = L.polyline([p1, p2], {color: '#dc3545', dashArray: '10, 10', weight: 3}).addTo(map);
        }

        // --- –ì–†–ê–ù–ò–¶–´ (–ü–û–õ–ò–ì–û–ù) ---
        function togglePoly() {
            showBoundaries = !showBoundaries;
            var btn = document.getElementById('poly-btn');
            btn.innerText = showBoundaries ? "üï∏Ô∏è –ì—Ä–∞–Ω–∏—Ü—ã: ON" : "üï∏Ô∏è –ì—Ä–∞–Ω–∏—Ü—ã: OFF";
            btn.style.background = showBoundaries ? "#17a2b8" : "#007bff";
            drawBoundaries();
        }

        function drawBoundaries() {
            if (boundaryPoly) map.removeLayer(boundaryPoly);
            if (!showBoundaries || points.length < 3) return;

            // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            var latlngs = points.map(p => [p.lat, p.lng]);
            boundaryPoly = L.polygon(latlngs, {color: 'orange', fillOpacity: 0.2}).addTo(map);
        }

        // --- –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ ---
        function exportPoints() {
            if (points.length === 0) return alert("–ù–µ—Ç —Ç–æ—á–µ–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
            
            // –§–æ—Ä–º–∞—Ç –¥–ª—è Civil 3D (PENZD - Point, Easting, Northing, Z, Desc)
            // –ù–æ –º—ã —Å–¥–µ–ª–∞–µ–º: Name, X(North), Y(East), Z, Lat, Lon
            var csv = "Name,X(North),Y(East),H,Lat,Lon
";
            points.forEach(p => {
                csv += `${p.name},${p.x.toFixed(3)},${p.y.toFixed(3)},${p.h.toFixed(3)},${p.lat.toFixed(7)},${p.lng.toFixed(7)}
`;
            });

            var blob = new Blob([csv], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = "survey_points.txt"; // txt –æ—Ç–ª–∏—á–Ω–æ –µ—Å—Ç—Å—è —Ü–∏–≤–∏–ª–æ–º
            a.click();
        }

        function showImport() { document.getElementById('import-modal').style.display = 'flex'; }
        
        function processImport() {
            var raw = document.getElementById('import-area').value;
            var lines = raw.split('
');
            var count = 0;
            
            lines.forEach(line => {
                // –û–∂–∏–¥–∞–µ–º: Name, Lat, Lon (WGS84)
                // –ü—Ä–∏–º–µ—Ä: ST1, 59.90, 30.30
                var parts = line.split(',');
                if (parts.length >= 3) {
                    var name = parts[0].trim();
                    var lat = parseFloat(parts[1]);
                    var lng = parseFloat(parts[2]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        var grid = convertToGrid(lat, lng);
                        points.push({
                            id: Date.now() + Math.random(),
                            name: name, lat: lat, lng: lng,
                            x: grid.x, y: grid.y, h: 0
                        });
                        count++;
                    }
                }
            });
            
            alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${count} —Ç–æ—á–µ–∫`);
            document.getElementById('import-modal').style.display = 'none';
            renderPointsList();
            if(showBoundaries) drawBoundaries();
        }

        initMap();

    </script>
</body>
</html>
